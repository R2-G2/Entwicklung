<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verlauf — Diagramm</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--glass: rgba(255,255,255,0.03);--transition:#f59e0b}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial; margin:0; min-height:100vh; background:linear-gradient(180deg,#071024 0%, #07102a 60%); color:#e6eef8; display:flex; align-items:center; justify-content:center; padding:32px}
    .wrap{width:100%; max-width:1600px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:16px; padding:20px; box-shadow:0 8px 30px rgba(2,6,23,0.7); border:1px solid rgba(255,255,255,0.04)}
    header{display:flex; align-items:center; justify-content:space-between; gap:16px}
    h1{font-size:20px; margin:0; letter-spacing:-0.2px}
    p.lead{margin:4px 0 0; color:var(--muted); font-size:13px}
    .controls{display:flex; gap:8px; align-items:center}
    button{background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:8px 10px; border-radius:10px; cursor:pointer; font-weight:600}
    button.primary{background:linear-gradient(90deg,var(--accent),#4f46e5); border:none}
    .meta{display:flex; gap:12px; margin-top:14px; flex-wrap:wrap}
    .meta .item{background:var(--glass); padding:10px 14px; border-radius:12px; font-size:13px}
    .chart-wrap{margin-top:18px; height:600px;}
    canvas{display:block; width:100%; height:100%}
    .footer{margin-top:14px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:13px}
    a.small{color:var(--muted); text-decoration:underline}
    @media (max-width:640px){.chart-wrap{height:300px}}
    .fullscreen {position: fixed;top: 0;left: 0;width: 100vw;height: 100vh;background: rgba(0,0,0,0.95);display: none;align-items: center;justify-content: center;z-index: 1000;padding: 20px;}
    .fullscreen.active { display: flex; }
    .fullscreen canvas { width: 100%; height: 100%; max-width: 95vw; max-height: 90vh; }
    .close-fullscreen {position: absolute;top: 20px;right: 20px;background: var(--accent);color: #fff;border: none;padding: 10px 14px;border-radius: 8px;cursor: pointer;font-weight: 600;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div>
          <h1>Entwicklung</h1>
          <p class="lead">Visualisierung und Trendprognose der Werte über Zeit — interaktiv, exportierbar.</p>
        </div>
        <div class="controls">
          <button id="btnFullscreen">Vollbild</button>
          <button id="btnExport" class="primary">Als PNG speichern</button>
        </div>
      </header>

      <div class="meta">
        <div class="item">Start: <strong id="startVal">—</strong> (<em id="startDate">—</em>)</div>
        <div class="item">Ende: <strong id="endVal">—</strong> (<em id="endDate">—</em>)</div>
        <div class="item">Spanne: <strong id="spanVal">—</strong></div>
        <div class="item">Max: <strong id="maxVal">—</strong></div>
        <div class="item">Min: <strong id="minVal">—</strong></div>
        <div class="item">Differenz: <strong id="diffVal">—</strong></div>
      </div>

      <div class="chart-wrap">
        <canvas id="chart"></canvas>
      </div>

      <div class="footer">
        <div>Quelle: JSON-Daten (extern)</div>
        <div>
          <a id="downloadCsv" class="small" href="#">CSV herunterladen</a>
        </div>
      </div>
    </div>
  </div>

  <div class="fullscreen" id="fullscreenModal">
    <button class="close-fullscreen" id="closeFullscreen">Schließen</button>
    <canvas id="chartFullscreen"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <script>
    let originalChartConfig;
    let fullscreenChart;

    fetch('dates.json')
      .then(response => response.json())
      .then(dataJson => initChart(dataJson))
      .catch(err => console.error('Fehler beim Laden der JSON-Datei', err));

    function initChart(dataJson){
      const entries = Object.entries(dataJson).map(([d,v])=>({date:new Date(d), rawDate:d, value: Number(v)}));
      entries.sort((a,b)=>a.date - b.date);

      const values = entries.map(e=>e.value);
      const startDateObj = entries[0] ? entries[0].date : null;
      const endDateObj = entries[entries.length-1] ? entries[entries.length-1].date : null;
      const startDate = startDateObj ? startDateObj.toLocaleDateString('de-DE') : '-';
      const endDate = endDateObj ? endDateObj.toLocaleDateString('de-DE') : '-';
      const startVal = values[0];
      const endVal = values[values.length - 1];
      const spanVal = endVal - startVal;
      const maxVal = Math.max(...values.map(v=>isFinite(v)?v:0));
      const minVal = Math.min(...values.map(v=>isFinite(v)?v:0));
      const diffVal = maxVal - minVal;

      document.getElementById('startDate').textContent = startDate;
      document.getElementById('endDate').textContent = endDate;
      document.getElementById('startVal').textContent = startVal;
      document.getElementById('endVal').textContent = endVal;
      document.getElementById('spanVal').textContent = spanVal;
      document.getElementById('maxVal').textContent = maxVal;
      document.getElementById('minVal').textContent = minVal;
      document.getElementById('diffVal').textContent = diffVal;

      const lastEntry = entries[entries.length-1];

      const forecastEntries = [];
      const totalMonths = 6;
      const forecastStartVal = endVal;
      const diffs = [];
      for(let i=1;i<values.length;i++) diffs.push(values[i]-values[i-1]);
      const avgStep = diffs.reduce((a,b)=>a+b,0)/diffs.length;
      let forecastDate = new Date(lastEntry.date);
      let prevVal = forecastStartVal;
      for(let i=1;i<=totalMonths;i++){
        forecastDate = new Date(forecastDate);
        forecastDate.setMonth(forecastDate.getMonth()+1);
        const dynamicFactor = 1 + (Math.sin((i/totalMonths)*Math.PI));
        const nextVal = prevVal + avgStep * dynamicFactor;
        forecastEntries.push({date:new Date(forecastDate), value: Math.round(nextVal)});
        prevVal = nextVal;
      }

      const connector = [
        { x: lastEntry.date, y: lastEntry.value },
        { x: forecastEntries[0].date, y: forecastEntries[0].value }
      ];

      const allValues = [...values, ...forecastEntries.map(e=>e.value)];
      const globalMax = Math.max(...allValues);
      const globalMin = Math.min(...allValues);
      const globalDiff = globalMax - globalMin;

      const ctx = document.getElementById('chart');
      const gradient = ctx.getContext('2d').createLinearGradient(0,0,0,500);
      gradient.addColorStop(0, 'rgba(124,58,237,0.38)');
      gradient.addColorStop(1, 'rgba(79,70,229,0.03)');

      const forecastCtxGradient = ctx.getContext('2d').createLinearGradient(0,0,0,400);
      forecastCtxGradient.addColorStop(0, 'rgba(16,185,129,0.6)');
      forecastCtxGradient.addColorStop(1, 'rgba(16,185,129,0.2)');

      originalChartConfig = {
        type: 'line',
        data: {
          datasets: [
            {
              label: 'Historie',
              data: entries.map(e => ({x: e.date, y: e.value})),
              fill: true,
              backgroundColor: gradient,
              borderColor: 'rgba(124,58,237,0.95)',
              tension: 0.35,
              pointRadius: 6,
              pointHoverRadius: 8,
              pointBackgroundColor: 'rgba(255,255,255,1)',
              pointBorderColor: 'rgba(124,58,237,0.95)',
              pointBorderWidth: 2,
              borderWidth: 2,
            },
            {
              label: 'Übergang',
              data: connector,
              borderDash: [4,4],
              borderColor: 'rgba(234,179,8,0.8)',
              backgroundColor: 'rgba(234,179,8,0.3)',
              tension: 0.4,
              pointRadius: 0,
              pointHoverRadius: 0,
              borderWidth: 2,
            },
            {
              label: 'Prognose (6 Monate)',
              data: forecastEntries.map(e => ({x: e.date, y: e.value})),
              borderDash: [6,4],
              borderColor: 'rgba(16,185,129,0.9)',
              backgroundColor: forecastCtxGradient,
              fill: true,
              tension: 0.4,
              pointRadius: 4,
              pointHoverRadius: 6,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx)=> ` ${ctx.parsed.y.toLocaleString('de-DE')} Einheiten`
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'month', tooltipFormat: 'dd.MM.yyyy', displayFormats: {month: 'MMM yy'} },
              ticks: { source: 'data', autoSkip: true, maxRotation: 0, minRotation: 0 },
              grid: { display: false }
            },
            y: {
              beginAtZero: false,
              min: globalMin - (globalDiff * 0.1),
              max: globalMax + (globalDiff * 0.1),
              ticks: { callback: v => v.toLocaleString('de-DE') }
            }
          }
        }
      };

      const myChart = new Chart(ctx, originalChartConfig);

      document.getElementById('btnExport').addEventListener('click', ()=>{
        const a = document.createElement('a');
        a.href = myChart.toBase64Image();
        a.download = `werte-${startDate}_bis_${endDate}.png`;
        a.click();
      });

      document.getElementById('downloadCsv').addEventListener('click', (e)=>{
        e.preventDefault();
        let csv = 'Datum;Einheiten\\n';
        entries.forEach(r=>{ csv += `${r.rawDate};${r.value}\\n`; });
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `werte-${startDate}_bis_${endDate}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('btnFullscreen').addEventListener('click', ()=>{
        const modal = document.getElementById('fullscreenModal');
        modal.classList.add('active');
        const ctxFull = document.getElementById('chartFullscreen');
        fullscreenChart = new Chart(ctxFull, JSON.parse(JSON.stringify(originalChartConfig)));
        fullscreenChart.resize();
      });

      document.getElementById('closeFullscreen').addEventListener('click', ()=>{
        const modal = document.getElementById('fullscreenModal');
        modal.classList.remove('active');
        if(fullscreenChart){ fullscreenChart.destroy(); fullscreenChart = null; }
      });
    }
  </script>
</body>
</html>
